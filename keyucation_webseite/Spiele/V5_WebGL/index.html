<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>KeyUcation Generator</title>
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes" />
    <style>
      /* Vollbild, keine Scrollbars, dunkler Hintergrund wie in Datei #1 */
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #231F20;
      }
      #unity-container {
        position: fixed;
        inset: 0;
        width: 100%;
        height: 100%;
      }
      #unity-canvas {
        display: block; /* verhindert extra whitespace */
        /* tatsächliche Größe setzen wir per JS in Abhängigkeit von DPR */
      }
      /* optional: Platz für Warnmeldungen (falls benötigt) */
      #unity-warning {
        position: absolute;
        top: 10px; left: 10px; right: 10px;
        z-index: 20;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="unity-container">
      <canvas id="unity-canvas" tabindex="-1"></canvas>
      <div id="unity-warning"></div>
    </div>

<script src="Build/V5_WebGL.loader.js"></script>
<script>
  const canvas  = document.getElementById('unity-canvas');
  const warning = document.getElementById('unity-warning');

  function unityShowBanner(msg, type) {
    if (!warning) return;
    const div = document.createElement('div');
    div.innerHTML = msg;
    div.style.padding = '10px';
    div.style.borderRadius = '6px';
    if (type === 'error') { div.style.background = 'red'; div.style.color = 'white'; }
    else { div.style.background = 'yellow'; }
    warning.appendChild(div);
    warning.style.display = 'block';
    if (type !== 'error') setTimeout(() => {
      if (div.parentNode) warning.removeChild(div);
      warning.style.display = warning.children.length ? 'block' : 'none';
    }, 5000);
  }

  let unityInstance = null;
  let resizeTimer   = null;
  let lostContext   = false;

  // 1) Context-Loss robust abfangen
  canvas.addEventListener('webglcontextlost', (e) => {
    e.preventDefault();        // erlaubt Restore
    lostContext = true;
  }, false);
  canvas.addEventListener('webglcontextrestored', () => {
    lostContext = false;
    scheduleResize(50);
  }, false);

  // 2) Sichere Viewport-Ermittlung
  function getSafeViewport() {
    const de = document.documentElement;
    const ww = Math.max(de.clientWidth,  (window.innerWidth  || 0));
    const hh = Math.max(de.clientHeight, (window.innerHeight || 0));
    return { w: ww, h: hh };
  }

  // 3) Resize – niemals auf 0x0 setzen; bei fraglichen Werten warten
  function doResize() {
    const { w, h } = getSafeViewport();
    if (w < 2 || h < 2 || lostContext) {
      // Layout noch nicht stabil → später erneut versuchen
      scheduleResize(50);
      return;
    }

    // CSS-Logikgröße
    canvas.style.width  = w + 'px';
    canvas.style.height = h + 'px';

    // Physische Pixel (DPR)
    const dpr = window.devicePixelRatio || 1;
    const pw  = Math.max(2, Math.floor(w * dpr));
    const ph  = Math.max(2, Math.floor(h * dpr));

    if (canvas.width !== pw || canvas.height !== ph) {
      canvas.width  = pw;
      canvas.height = ph;
      try { unityInstance?.Module?.setCanvasSize?.(pw, ph, true); } catch (_) {}
    }
  }

  function scheduleResize(delay = 0) {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(doResize, delay);
  }

  // 4) Events: mehrfach und verzögert reagieren
  window.addEventListener('resize', () => scheduleResize(50));
  ['fullscreenchange', 'webkitfullscreenchange', 'msfullscreenchange'].forEach(ev =>
    document.addEventListener(ev, () => { scheduleResize(16); scheduleResize(120); }, true)
  );
  document.addEventListener('visibilitychange', () => { if (!document.hidden) scheduleResize(50); });

  // 5) Unity starten
  createUnityInstance(canvas, {
    dataUrl: "Build/V5_WebGL.data",
    frameworkUrl: "Build/V5_WebGL.framework.js",
    codeUrl: "Build/V5_WebGL.wasm",
    streamingAssetsUrl: "StreamingAssets",
    companyName: "Bockito Games",
    productName: "KeyUcation Generator",
    productVersion: "0.1",
    showBanner: unityShowBanner,
    devicePixelRatio: window.devicePixelRatio || 1
  }).then((instance) => {
    unityInstance = instance;
    scheduleResize(0);
    scheduleResize(120); // nach Layout-Settle noch einmal
  }).catch((message) => {
    alert(message);
  });

  // Initial
  scheduleResize(0);
</script>

  </body>
</html>
