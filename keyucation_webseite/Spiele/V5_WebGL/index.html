<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>KeyUcation Generator</title>
    <meta name="viewport"
          content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=no, shrink-to-fit=yes, viewport-fit=cover" />
    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #231F20;
      }
      #unity-container {
        position: fixed;
        inset: 0;
        width: 100%;
        height: 100%;
      }
      #unity-canvas {
        display: block;
      }
      #unity-warning {
        position: absolute;
        top: 10px; left: 10px; right: 10px;
        z-index: 20;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="unity-container">
      <canvas id="unity-canvas" tabindex="-1"></canvas>
      <div id="unity-warning"></div>
    </div>

<script src="Build/V5_WebGL.loader.js"></script>
<script>
  const canvas  = document.getElementById('unity-canvas');
  const warning = document.getElementById('unity-warning');

  // Hilfsbanner
  function unityShowBanner(msg, type) {
    if (!warning) return;
    const div = document.createElement('div');
    div.innerHTML = msg;
    div.style.padding = '10px';
    div.style.borderRadius = '6px';
    if (type === 'error') { div.style.background = 'red'; div.style.color = 'white'; }
    else { div.style.background = 'yellow'; }
    warning.appendChild(div);
    warning.style.display = 'block';
    if (type !== 'error') setTimeout(() => {
      if (div.parentNode) warning.removeChild(div);
      warning.style.display = warning.children.length ? 'block' : 'none';
    }, 5000);
  }

  let unityInstance = null;
  let resizeTimer   = null;
  let lostContext   = false;

  // 1) Context-Loss abfangen
  canvas.addEventListener('webglcontextlost', (e) => {
    e.preventDefault();
    lostContext = true;
  }, false);
  canvas.addEventListener('webglcontextrestored', () => {
    lostContext = false;
    scheduleResize(50);
  }, false);

  // 2) Browser-Limits ermitteln
  const CAP_DPR = 1; // feste Obergrenze
  let GL_MAX = 8192;
  try {
    const tmp = document.createElement('canvas');
    const gl  = tmp.getContext('webgl2') || tmp.getContext('webgl');
    if (gl) GL_MAX = gl.getParameter(gl.MAX_RENDERBUFFER_SIZE) || GL_MAX;
  } catch {}

  function getSafeViewport() {
    const de = document.documentElement;
    const ww = Math.max(de.clientWidth,  (window.innerWidth  || 0));
    const hh = Math.max(de.clientHeight, (window.innerHeight || 0));
    return { w: ww, h: hh };
  }

  function getSafeDPR(w, h) {
    const raw   = Math.min(window.devicePixelRatio || 1, CAP_DPR);
    const limit = Math.min(GL_MAX / Math.max(w, 1), GL_MAX / Math.max(h, 1));
    return Math.max(0.5, Math.min(raw, limit));
  }

  // 3) Resize
  function doResize() {
    const { w, h } = getSafeViewport();
    if (w < 2 || h < 2 || lostContext) {
      scheduleResize(50);
      return;
    }
    canvas.style.width  = w + 'px';
    canvas.style.height = h + 'px';

    const dpr = getSafeDPR(w, h);
    const pw  = Math.max(2, Math.floor(w * dpr));
    const ph  = Math.max(2, Math.floor(h * dpr));

    if (canvas.width !== pw || canvas.height !== ph) {
      canvas.width  = pw;
      canvas.height = ph;
      try { unityInstance?.Module?.setCanvasSize?.(pw, ph, true); } catch {}
    }
  }

  function scheduleResize(delay = 0) {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(doResize, delay);
  }

  // 4) Events
  window.addEventListener('resize', () => scheduleResize(50));
  ['fullscreenchange', 'webkitfullscreenchange', 'msfullscreenchange'].forEach(ev =>
    document.addEventListener(ev, () => { scheduleResize(16); scheduleResize(120); }, true)
  );
  document.addEventListener('visibilitychange', () => { if (!document.hidden) scheduleResize(50); });

  // 5) Unity starten
  createUnityInstance(canvas, {
    dataUrl: "Build/V5_WebGL.data",
    frameworkUrl: "Build/V5_WebGL.framework.js",
    codeUrl: "Build/V5_WebGL.wasm",
    streamingAssetsUrl: "StreamingAssets",
    companyName: "Bockito Games",
    productName: "KeyUcation Generator",
    productVersion: "0.1",
    showBanner: unityShowBanner,
    devicePixelRatio: 1 // feste Vorgabe, nicht window.devicePixelRatio
  }).then((instance) => {
    unityInstance = instance;
    scheduleResize(0);
    scheduleResize(120);
  }).catch((message) => {
    alert(message);
  });

  scheduleResize(0);
</script>
  </body>
</html>
